_format_version: "3.0"
_transform: true

services:
  # User Service
  - name: user-service
    url: http://user-service:3001
    routes:
      - name: user-auth-routes
        paths:
          - /auth
        strip_path: false
      - name: user-api-routes
        paths:
          - /api/v1/users
        strip_path: false

  # Product Service
  - name: product-service
    url: http://product-service:8080
    routes:
      - name: product-routes
        paths:
          - /api/v1/products
        strip_path: false
      - name: category-routes
        paths:
          - /api/v1/categories
        strip_path: false

  # Order Service
  - name: order-service
    url: http://order-service:8080
    routes:
      - name: order-routes
        paths:
          - /api/v1/orders
        strip_path: false

  # Payment Service
  - name: payment-service
    url: http://payment-service:3004
    routes:
      - name: payment-routes
        paths:
          - /api/v1/payments
        strip_path: false
      - name: refund-routes
        paths:
          - /api/v1/refunds
        strip_path: false

  # Inventory Service
  - name: inventory-service
    url: http://inventory-service:3005
    routes:
      - name: inventory-routes
        paths:
          - /api/v1/inventory
        strip_path: false
      - name: reservation-routes
        paths:
          - /api/v1/reservations
        strip_path: false

  # Cart Service
  - name: cart-service
    url: http://cart-service:3006
    routes:
      - name: cart-routes
        paths:
          - /api/v1/cart
        strip_path: false

  # Review Service
  - name: review-service
    url: http://review-service:3007
    routes:
      - name: review-routes
        paths:
          - /api/v1/reviews
        strip_path: false

  # Search Service
  - name: search-service
    url: http://search-service:8080
    routes:
      - name: search-routes
        paths:
          - /api/v1/search
        strip_path: false

  # Notification Service
  - name: notification-service
    url: http://notification-service:3009
    routes:
      - name: notification-routes
        paths:
          - /api/v1/notifications
        strip_path: false

  # Recommendation Service
  - name: recommendation-service
    url: http://recommendation-service:3010
    routes:
      - name: recommendation-routes
        paths:
          - /api/v1/recommendations
        strip_path: false

plugins:
  # Global CORS plugin
  - name: cors
    config:
      origins:
        - "*"
      methods:
        - GET
        - POST
        - PUT
        - PATCH
        - DELETE
        - OPTIONS
      headers:
        - Accept
        - Authorization
        - Content-Type
        - X-User-ID
        - X-User-Roles
        - X-Request-ID
      exposed_headers:
        - X-Request-ID
      credentials: true
      max_age: 3600

  # Global rate limiting
  - name: rate-limiting
    config:
      minute: 100
      policy: local
      fault_tolerant: true
      hide_client_headers: false

  # Request logging
  - name: file-log
    config:
      path: /dev/stdout
      reopen: true

  # Request ID
  - name: correlation-id
    config:
      header_name: X-Request-ID
      generator: uuid
      echo_downstream: true

consumers:
  - username: web-app
    keyauth_credentials:
      - key: web-app-key-secret

  - username: mobile-app
    keyauth_credentials:
      - key: mobile-app-key-secret

  - username: admin-app
    keyauth_credentials:
      - key: admin-app-key-secret
